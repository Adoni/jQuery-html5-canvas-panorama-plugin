/*
 * ddpanorama - jQuery plugin version 1.10
 * Copyright (c) Tiny Studio (http://tinystudio.dyndns.org/)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * Date: Wed Apr  4 09:42:51 KST 2012
 */

(function(a){var b={animations:[],timerId:-1,max_speed:43e3,drag_constant:1.6,cursorX:0,cursorY:0,currentTime:(new Date).getTime()};b.timerId=window.setInterval(function(){for(var a=0;a<b.animations.length;++a){b.animations[a].update()}},1e3/30);b.mousedown=function(a,c){b.cursorXOld=b.cursorX=a;b.cursorYOld=b.cursorY=c;b.speedX=0};b.mousemove=function(a,c){b.cursorXOld=b.cursorX;b.cursorYOld=b.cursorY;b.cursorX=a;b.cursorY=c;var d=(new Date).getTime();var e=(d-b.currentTime)/1e3;b.currentTime=d;b.speedX=(b.cursorX-b.cursorXOld)/e;if(b.speedX>b.max_speed)b.speedX=b.max_speed;if(b.speedX<-b.max_speed)b.speedX=-b.max_speed};b.event_prefix="ddpanorama_";a(document).bind("mousemove",function(a){b.mousemove(a.pageX,a.pageY)});a(document).bind("touchmove",function(a){b.mousemove(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY)});a(document).bind("touchstart",function(a){b.mousedown(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY)});a(document).bind("mousedown",function(a){b.mousedown(a.pageX,a.pageY)});a.fn.ddpanorama=function(c){return this.each(function(){if(a(this).data("ddpanorama")!=null)return;var d=a(this);var e=a(this).parent();var f=document.createElement("canvas");var g={img:d,canvas:f,mousedown:false,draw_scale:1};a(this).css("display","none");g.params=c;if(g.params==null)g.params={};g.remove=function(){var a=b.animations.indexOf(this);if(a>=0){b.animations.splice(a,1)}};g.setScrollX=function(b){var c=a(this.img).get()[0].naturalWidth/this.draw_scale;while(b>=c)b-=c;while(b<-c)b+=c;a(this.canvas).prop("scrollX",b);return b};g.scrollTo=function(b){var c=a(this.canvas).prop("mousedownScrollX");if(c==null)return;var e=a(d).get()[0].naturalWidth;this.setScrollX(c+b-a(this.canvas).prop("mousedownPageX"))};g.update=function(){var c=(new Date).getTime();var d=a(this.canvas).prop("mousemoveTime");a(this.canvas).prop("mousemoveTime",c);var e=(c-d)/1e3;var f=a(this.canvas).prop("scrollX");var g=a(this.canvas).prop("speedX");var h=this.canvas.getContext("2d");var i=a(this.img).get()[0].naturalWidth;this.setScrollX(f+e*g);g+=-b.drag_constant*g*e;a(this.canvas).prop("speedX",g);this.redraw();if(Math.abs(g)<1){this.stop();this.remove()}};g.stop=function(){a(this.canvas).prop("speedX",0)};g.redraw=function(){var c=a(this.img).get()[0].naturalWidth;var d=this.canvas.getContext("2d");var e=a(this.canvas).prop("scrollX");e/=this.draw_scale;var f=false;if(isNaN(c)==false&&c!=0){while(e<-c)e+=c;while(e>=c)e-=c;var g=this.img.get()[0];d.setTransform(this.draw_scale,0,0,this.draw_scale,0,0);d.drawImage(g,e,0);d.drawImage(g,e+c,0);d.drawImage(g,e-c,0);f=true}else{d.setTransform(1,0,0,1,0,0);d.fillStyle="#000000";d.fillRect(0,0,this.canvas.width,this.canvas.height)}a(this.img).trigger(jQuery.Event(b.event_prefix+"redraw",{canvas:this.canvas,speed:a(this.canvas).prop("speedX")/b.max_speed,loaded:f}))};g.onmousedown=function(b){var c=this;var d=this.canvas;this.mousedown=true;a(d).prop("speedX",0);var e=(new Date).getTime();this.remove();this.stop();a(d).prop("mousedownPageX",b);a(d).prop("mousedownScrollX",a(d).prop("scrollX"));a(d).prop("mousemoveTime",e)};g.resize=function(){var b=this.img;var c=this.canvas;var d=b.get()[0].naturalWidth;var e=b.get()[0].naturalHeight;if(this.params.hasOwnProperty("height")){e=this.params.height;this.draw_scale=e/b.get()[0].naturalHeight}else{this.params.draw_scale=1}if(this.params.hasOwnProperty("ratio")){d=e/this.params.ratio}else if(this.params.hasOwnProperty("width")){d=this.params.width}a(c).attr("width",d);a(c).attr("height",e)};a(this).data("ddpanorama",g);a(f).data("ddpanorama",g);a(f).prop("scrollX",0);a(f).prop("speedX",0);a(f).mousedown(function(b){var c=a(this).data("ddpanorama");c.onmousedown(b.pageX)});var h=function(c){var d=a(this).data("ddpanorama");if(d.mousedown==false)return;d.mousedown=false;b.animations.push(d);var e=(new Date).getTime();var g=a(this).prop("mousemoveTime");a(this).prop("mousemoveTime",e);a(f).prop("speedX",b.speedX);a(f).prop("mousedownScrollX",null)};a(f).bind("mouseup",h);a(f).bind("mouseupoutside",h);a(f).bind("mousemove",function(b){var c=b.pageX;var d=a(this).data("ddpanorama");if(d.mousedown==false)return;d.scrollTo(c);d.redraw()});a(f).bind("contextmenu",function(a){a.preventDefault();return false});a(f).bind("touchstart",function(b){var c=a(this).data("ddpanorama");c.onmousedown(b.originalEvent.touches[0].pageX)});a(f).bind("touchmove",function(b){b.preventDefault();var c=a(this).data("ddpanorama");if(c.mousedown==false)return false;var d=b.originalEvent.touches[0].pageX;c.scrollTo(d);c.redraw()});a(f).bind("touchend",h);g.resize();g.redraw();e.append(f);a(this).load(function(){g.resize();g.redraw()})})}})(jQuery)